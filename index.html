<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Communication</title>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
    <h1>P2P Communication Example</h1>
    <div>
        <label for="messageInput">Message:</label>
        <input type="text" id="messageInput">
        <button id="sendButton">Send</button>
    </div>

    <script>
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const startButton = document.createElement('button');
        const localVideo = document.createElement('video');
        const remoteVideo = document.createElement('video');

        let localConnection;
        let remoteConnection;
        let dataChannel;

        startButton.textContent = 'Start P2P Connection';
        document.body.appendChild(startButton);
        document.body.appendChild(localVideo);
        document.body.appendChild(remoteVideo);

        startButton.addEventListener('click', async () => {
            try {
                // Create local peer connection
                localConnection = new RTCPeerConnection();

                // Create data channel for communication
                dataChannel = localConnection.createDataChannel('myDataChannel');

                dataChannel.onopen = (event) => {
                    console.log('Data channel opened');
                };

                dataChannel.onmessage = (event) => {
                    console.log('Received message:', event.data);
                    // Display received message on the webpage
                    displayMessage(event.data, 'Received');
                };

                // Set up local ICE candidate events
                localConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // Send local ICE candidate to the remote peer
                        // This is usually done through a signaling server in a real-world scenario
                        console.log('Local ICE candidate:', event.candidate);
                    }
                };

                // Set up local video stream
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                localVideo.srcObject = stream;
                localConnection.addStream(stream);

                // Create offer to start the WebRTC connection
                const offer = await localConnection.createOffer();
                await localConnection.setLocalDescription(offer);

                // Send the offer to the remote peer
                // This is where you would typically use a signaling server
                console.log('Offer created:', offer);

                // Simulate receiving the offer on the remote side
                // In a real-world scenario, you would exchange this information with the remote peer
                const receivedOffer = offer;

                // Create remote peer connection
                remoteConnection = new RTCPeerConnection();

                // Set up remote ICE candidate events
                remoteConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // Send remote ICE candidate to the local peer
                        // This is usually done through a signaling server in a real-world scenario
                        console.log('Remote ICE candidate:', event.candidate);
                    }
                };

                // Set up remote video stream
                remoteConnection.ontrack = (event) => {
                    remoteVideo.srcObject = event.streams[0];
                };

                // Set received offer as remote description
                await remoteConnection.setRemoteDescription(receivedOffer);

                // Create answer to accept the connection
                const answer = await remoteConnection.createAnswer();
                await remoteConnection.setLocalDescription(answer);

                // Send the answer to the local peer
                // This is where you would typically use a signaling server
                console.log('Answer created:', answer);

                // Simulate receiving the answer on the local side
                // In a real-world scenario, you would exchange this information with the local peer
                const receivedAnswer = answer;

                // Set received answer as local description
                await localConnection.setRemoteDescription(receivedAnswer);

                // Enable UI for message sending
                enableMessagingUI();
            } catch (error) {
                console.error('Error creating P2P connection:', error);
            }
        });

        sendButton.addEventListener('click', () => {
            // Send the message through the data channel
            const message = messageInput.value;
            dataChannel.send(message);
            // Display sent message on the webpage
            displayMessage(message, 'Sent');
            // Clear the input field
            messageInput.value = '';
        });

        function enableMessagingUI() {
            messageInput.removeAttribute('disabled');
            sendButton.removeAttribute('disabled');
        }

        function displayMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = `${type}: ${message}`;
            document.body.appendChild(messageDiv);
        }
    </script>
</body>
</html>